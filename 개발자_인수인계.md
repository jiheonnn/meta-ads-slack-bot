# 아임웹 주문 조회 시스템 개발자 인수인계 문서

## 🎯 프로젝트 개요
athlogic.kr에서 웹앱 상품을 판매하고, 구매자만 athlogic.app에 접근할 수 있도록 하기 위해 구매자 정보를 자동으로 가져오는 시스템

## 🔄 개발 과정 요약

### 1차 시도: API Key 방식
- athlogic.kr의 API Key 사용 시도
- **실패 원인**: API Key가 비활성화 상태 (errorCode 30105)

### 2차 시도: OAuth 방식
- 아임웹 개발자센터에서 OAuth 앱 생성
- **난관들**:
  1. "연동되지 않은 사이트" 오류 → 개발자센터에서 앱-사이트 연동 필요
  2. "Invalid redirect uri" 오류 → 정확한 URI 찾기 필요
  3. Site Code 오류 → 올바른 사이트 코드 확인 필요
  4. Scope 권한 오류 → `site-info:write`가 필수 권한임을 발견

### 최종 해결
- OAuth 2.0 Authorization Code Flow 사용
- 필수 scope: `site-info:write order:read`
- Redirect URI: `https://petebaek0712000.imweb.me/`

## 🏗️ 시스템 구조

```
1. OAuth 인증 (get_first_token.py)
   ↓
2. 토큰 저장 (imweb_tokens.json)
   ↓
3. 주문 조회 (get_orders_oauth_correct.py)
   ↓
4. 구매자 정보 추출 및 CSV 저장
```

## 📝 핵심 코드 설명

### 1. OAuth 인증 URL 생성
```python
params = {
    'responseType': 'code',
    'clientId': CLIENT_ID,
    'redirectUri': REDIRECT_URI,
    'scope': 'site-info:write order:read',  # 필수!
    'siteCode': SITE_CODE,
    'state': 'random_state'
}
```

### 2. 주문 조회 시 주의사항
- 날짜 파라미터: `startWtime`, `endWtime` (UTC ISO8601 형식)
- 응답 구조: `data.list` (문서와 다름)
- 상품명 위치: `sections[].sectionItems[].productInfo.prodName`
- 구매자 정보: `ordererName`, `ordererCall`, `ordererEmail`

### 3. 페이지네이션 필수
```python
params = {
    'page': 1,
    'limit': 100  # 필수 파라미터
}
```

## 🚨 주요 이슈 및 해결

### 1. 아임웹 API 문서와 실제 구현의 차이
- 문서: `data.orders`
- 실제: `data.list`

### 2. 날짜 필터가 작동하지 않음
- API의 날짜 필터가 제대로 작동하지 않아 전체 조회 후 필터링 필요

### 3. 토큰 갱신
- Access Token 만료 시 자동 갱신 구현
- `oauth_token_manager.py`에서 처리

## 🔗 연동 필요 사항

### athlogic.app 측 구현 필요
1. 구매자 등록 API 엔드포인트
2. 구매자 인증 시스템
3. 구매자 데이터베이스

### 자동화 제안
```python
# 5분마다 새 구매자 확인
import schedule
import time

def check_new_buyers():
    # get_orders_oauth_correct.py 로직 실행
    pass

schedule.every(5).minutes.do(check_new_buyers)

while True:
    schedule.run_pending()
    time.sleep(1)
```

## 📚 참고 자료
- 아임웹 API 문서: `imweb_guide.md`
- OAuth 2.0 스펙: https://oauth.net/2/

## ⚡ 빠른 시작
```bash
# 1. 패키지 설치
pip3 install requests

# 2. 토큰 발급 (최초 1회)
python3 get_first_token.py

# 3. 주문 조회
python3 get_orders_oauth_correct.py
```

## 🔮 향후 개선 사항
1. 웹훅 방식 도입 (아임웹이 지원 시)
2. 실시간 동기화
3. 구매자 자동 알림 시스템
4. 관리자 대시보드 구현